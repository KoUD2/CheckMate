#!/bin/bash

set -e

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน CheckMate Bot..."

# ะัะพะฒะตััะตะผ, ััะพ ะฒัะต ะฝะตะพะฑัะพะดะธะผัะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ัััะฐะฝะพะฒะปะตะฝั
check_env_vars() {
    local required_vars=("TELEGRAM_BOT_TOKEN" "GEMINI_API_KEY" "OCR_API_KEY")
    for var in "${required_vars[@]}"; do
        if [ -z "${!var}" ]; then
            echo "โ ะัะธะฑะบะฐ: ะะตัะตะผะตะฝะฝะฐั ะพะบััะถะตะฝะธั $var ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ"
            echo "๐ ะัะพะฒะตัััะต ัะฐะนะป .env ะธะปะธ ัััะฐะฝะพะฒะธัะต ะฟะตัะตะผะตะฝะฝัะต ัะธััะตะผั"
            exit 1
        fi
    done
    echo "โ ะัะต ะพะฑัะทะฐัะตะปัะฝัะต ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ัััะฐะฝะพะฒะปะตะฝั"
}

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "โ๏ธ  ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ. ะกะพะทะดะฐะนัะต ะตะณะพ ะฝะฐ ะพัะฝะพะฒะต env.example"
    echo "   cp env.example .env"
    echo "   # ะััะตะดะฐะบัะธััะนัะต .env ั ะฒะฐัะธะผะธ ะทะฝะฐัะตะฝะธัะผะธ"
    exit 1
fi

# ะะฐะณััะถะฐะตะผ ะฟะตัะตะผะตะฝะฝัะต ะธะท .env
source .env

# ะัะพะฒะตััะตะผ ะฟะตัะตะผะตะฝะฝัะต
check_env_vars

echo "๐๏ธ  ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะต ะบะพะฝัะตะนะฝะตัั..."
docker-compose down --remove-orphans || true

echo "๐๏ธ  ะกะพะฑะธัะฐะตะผ ะฝะพะฒัะน ะพะฑัะฐะท..."
docker-compose build --no-cache

echo "๐ฆ ะกะพะทะดะฐะตะผ ะฝะตะพะฑัะพะดะธะผัะต ะดะธัะตะบัะพัะธะธ..."
mkdir -p logs

echo "๐ ะะฐะฟััะบะฐะตะผ ัะตัะฒะธั..."
docker-compose up -d

echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ัะตัะฒะธัะฐ..."
sleep 10

echo "๐ ะัะพะฒะตััะตะผ ััะฐััั ะบะพะฝัะตะนะฝะตัะฐ..."
if docker-compose ps | grep -q "Up"; then
    echo "โ ะะพะฝัะตะนะฝะตั ะทะฐะฟััะตะฝ ััะฟะตัะฝะพ"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะบะพะฝัะตะนะฝะตัะฐ"
    echo "๐ ะะพะณะธ ะบะพะฝัะตะนะฝะตัะฐ:"
    docker-compose logs --tail=20
    exit 1
fi

echo "๐ ะัะพะฒะตััะตะผ health check..."
sleep 5
if curl -f http://localhost:8443/health > /dev/null 2>&1; then
    echo "โ Health check ะฟัะพัะตะป ััะฟะตัะฝะพ"
else
    echo "โ๏ธ  Health check ะฝะต ะฟัะพัะตะป, ะฝะพ ะบะพะฝัะตะนะฝะตั ะทะฐะฟััะตะฝ"
fi

echo "๐ ะะฝัะพัะผะฐัะธั ะพ ะทะฐะฟััะตะฝะฝะพะผ ัะตัะฒะธัะต:"
docker-compose ps

echo "๐ ะะพัะปะตะดะฝะธะต ะปะพะณะธ:"
docker-compose logs --tail=10

echo ""
echo "๐ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ!"
echo ""
echo "๐ก ะกะตัะฒะธั ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: http://localhost:8443"
echo "๐ฅ Health check: http://localhost:8443/health"
echo "๐ ะัะพัะผะพัั ะปะพะณะพะฒ: docker-compose logs -f"
echo "๐ ะััะฐะฝะพะฒะบะฐ ัะตัะฒะธัะฐ: docker-compose down"
echo "" 