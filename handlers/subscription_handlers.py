from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ContextTypes
import logging
from datetime import datetime, timedelta
import re
import json
import os

from services.payment_service import create_payment_link
from services.api_service import get_user_subscription, calculate_days_left, update_user_subscription
from services.payment_callbacks import get_all_active_subscriptions, activate_subscription

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logger = logging.getLogger(__name__)

# –§–∞–π–ª –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
PROMO_CODES_FILE = "promo_codes.json"

# –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
PROMO_CODES = {
    "TEACHY": {
        "days": 30,
        "end_date": datetime(2025, 8, 9, 23, 59, 59),
        "description": "–ü—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π"
    },
    "NATALYAPRO": {
        "days": 30,
        "end_date": datetime(2025, 12, 31, 23, 59, 59),
        "description": "–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ NatalyaPRO"
    }
}

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ë–î)
USED_PROMO_CODES = set()

def load_promo_codes():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥—ã –∏–∑ —Ñ–∞–π–ª–∞"""
    global PROMO_CODES
    if os.path.exists(PROMO_CODES_FILE):
        try:
            with open(PROMO_CODES_FILE, 'r', encoding='utf-8') as f:
                data = json.load(f)
                # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ –≤ datetime –æ–±—ä–µ–∫—Ç—ã
                for code, info in data.items():
                    if isinstance(info['end_date'], str):
                        info['end_date'] = datetime.fromisoformat(info['end_date'])
                PROMO_CODES.update(data)
                logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(data)} –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: {e}")

def save_promo_codes():
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥—ã –≤ —Ñ–∞–π–ª"""
    try:
        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º datetime –æ–±—ä–µ–∫—Ç—ã –≤ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è JSON
        data_to_save = {}
        for code, info in PROMO_CODES.items():
            data_to_save[code] = {
                'days': info['days'],
                'end_date': info['end_date'].isoformat(),
                'description': info['description']
            }
        
        with open(PROMO_CODES_FILE, 'w', encoding='utf-8') as f:
            json.dump(data_to_save, f, ensure_ascii=False, indent=2)
        logger.info(f"–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ {len(PROMO_CODES)} –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤ –≤ —Ñ–∞–π–ª")
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤: {e}")

def is_promo_code_used(user_id: int, promo_code: str) -> bool:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–º–æ–∫–æ–¥"""
    return f"{user_id}_{promo_code}" in USED_PROMO_CODES

def mark_promo_code_as_used(user_id: int, promo_code: str) -> None:
    """–û—Ç–º–µ—á–∞–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π"""
    USED_PROMO_CODES.add(f"{user_id}_{promo_code}")
    logger.info(f"–ü—Ä–æ–º–æ–∫–æ–¥ {promo_code} –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

async def promo_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /promo –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥
    if not context.args:
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥.\n\n"
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /promo <–∫–æ–¥>"
        )
        return
    
    promo_code = context.args[0].upper()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–º–æ–∫–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if promo_code not in PROMO_CODES:
        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥.\n\n"
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∫–æ–¥–∞."
        )
        return
    
    promo_info = PROMO_CODES[promo_code]
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
    if datetime.now() > promo_info["end_date"]:
        await update.message.reply_text(
            f"‚ùå –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∏—Å—Ç–µ–∫.\n\n"
            f"–ü—Ä–æ–º–æ–∫–æ–¥ –¥–µ–π—Å—Ç–≤–æ–≤–∞–ª –¥–æ {promo_info['end_date'].strftime('%d.%m.%Y')}."
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥ —Ä–∞–Ω–µ–µ
    if is_promo_code_used(user_id, promo_code):
        await update.message.reply_text(
            "‚ùå –í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥.\n\n"
            "–ö–∞–∂–¥—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑."
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
    local_subscriptions = get_all_active_subscriptions()
    local_subscription = local_subscriptions.get(user_id)
    
    has_active_subscription = False
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É
    if local_subscription and local_subscription.get("is_active"):
        expiry_date = local_subscription.get("expiry_date")
        if expiry_date and expiry_date > datetime.now():
            has_active_subscription = True
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é –ª–æ–∫–∞–ª—å–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º API –ø–æ–¥–ø–∏—Å–∫—É
    if not has_active_subscription:
        user_data = await get_user_subscription(user_id)
        if user_data and user_data.get("IsActive", False):
            has_active_subscription = True
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω—É—é API –ø–æ–¥–ø–∏—Å–∫—É")
    
    if has_active_subscription:
        await update.message.reply_text(
            "‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.\n\n"
            "–£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞. –ü—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑."
        )
        return
    
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É —á–µ—Ä–µ–∑ API
    logger.info(f"–ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ø–æ –ø—Ä–æ–º–æ–∫–æ–¥—É {promo_code} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
    api_success = await update_user_subscription(user_id, promo_info["days"])
    
    # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É –ª–æ–∫–∞–ª—å–Ω–æ (–≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ API)
    activate_subscription(user_id, promo_info["days"])
    
    # –û—Ç–º–µ—á–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
    mark_promo_code_as_used(user_id, promo_code)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–ø–∏—Å–∫–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    subscription = get_all_active_subscriptions().get(user_id)
    expiry_date_str = subscription["expiry_date"].strftime("%d.%m.%Y")
    days_left = (subscription["expiry_date"] - datetime.now()).days
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ API
    if api_success:
        message = f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ {promo_code} —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!\n\n"
    else:
        message = f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ {promo_code} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ!\n\n"
        message += "‚ö†Ô∏è –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ. API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.\n\n"
    
    message += f"–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ {expiry_date_str}.\n"
    message += f"–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: {days_left}.\n\n"
    message += f"–°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CheckMate!"
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
    await update.message.reply_text(message)
    
    logger.info(f"–ü—Ä–æ–º–æ–∫–æ–¥ {promo_code} —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

async def add_promo_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /addpromo –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–æ–∫–æ–¥–∞"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å–ø–∏—Å–æ–∫, —á—Ç–æ –∏ –≤ admin_handlers.py)
    ADMIN_IDS = {1054927360}
    if user_id not in ADMIN_IDS:
        await update.message.reply_text(
            "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥—ã."
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥
    if not context.args:
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞.\n\n"
            "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addpromo <–ù–ê–ó–í–ê–ù–ò–ï_–ü–†–û–ú–û–ö–û–î–ê>"
        )
        return
    
    promo_code = context.args[0].upper()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
    if not re.match(r'^[A-Z0-9]+$', promo_code):
        await update.message.reply_text(
            "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã."
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if promo_code in PROMO_CODES:
        await update.message.reply_text(
            f"‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ {promo_code} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
        )
        return
    
    # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–∞ –º–µ—Å—è—Ü (30 –¥–Ω–µ–π)
    new_promo = {
        "days": 30,
        "end_date": datetime.now() + timedelta(days=365),  # –î–µ–π—Å—Ç–≤—É–µ—Ç –≥–æ–¥
        "description": f"–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥ {promo_code}"
    }
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–º–æ–∫–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
    PROMO_CODES[promo_code] = new_promo
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
    save_promo_codes()
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    await update.message.reply_text(
        f"‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ {promo_code} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!\n\n"
        f"üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n"
        f"   ‚Ä¢ –ü–µ—Ä–∏–æ–¥: 30 –¥–Ω–µ–π\n"
        f"   ‚Ä¢ –î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ: {new_promo['end_date'].strftime('%d.%m.%Y')}\n"
        f"   ‚Ä¢ –¢–∏–ø: –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π\n"
        f"   ‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: {new_promo['description']}\n\n"
        f"üé´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π:\n"
        f"   /promo {promo_code}"
    )
    
    logger.info(f"–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä {user_id} —Å–æ–∑–¥–∞–ª –Ω–æ–≤—ã–π –ø—Ä–æ–º–æ–∫–æ–¥: {promo_code}")

async def subscription_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /subscription"""
    user_id = update.effective_user.id
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–∞—á–∞–ª–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏)
    local_subscriptions = get_all_active_subscriptions()
    local_subscription = local_subscriptions.get(user_id)
    
    is_active = False
    days_left = 0
    
    if local_subscription and local_subscription.get("is_active"):
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ –ª–∏ –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞
        expiry_date = local_subscription.get("expiry_date")
        if expiry_date and expiry_date > datetime.now():
            is_active = True
            days_left = (expiry_date - datetime.now()).days
            logger.info(f"–ù–∞–π–¥–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å: {days_left}")
    
    # –ï—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º API (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    if not is_active:
        user_data = await get_user_subscription(user_id)
        
        if user_data and user_data.get("IsActive", False):
            # –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –≤ API
            is_active = True
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –≤—ã—á–∏—Å–ª—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –¥–Ω–∏
            sub_until = user_data.get("SubUntil", "")
            if sub_until:
                days_left = calculate_days_left(sub_until)
            logger.info(f"–ù–∞–π–¥–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è API –ø–æ–¥–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å: {days_left}")
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    if is_active:
        if days_left == 1:
            message_text = f"‚úÖ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞.\n–û—Å—Ç–∞–ª—Å—è 1 –¥–µ–Ω—å."
        elif days_left < 5:
            message_text = f"‚úÖ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞.\n–û—Å—Ç–∞–ª–æ—Å—å {days_left} –¥–Ω—è."
        else:
            message_text = f"‚úÖ –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞.\n–û—Å—Ç–∞–ª–æ—Å—å {days_left} –¥–Ω–µ–π."
    else:
        # –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
        message_text = "‚ùå –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∏—Å—Ç–µ–∫–ª–∞"
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ–¥–ø–∏—Å–∫–∏
    message_text += "\n\n–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏: 149 —Ä—É–±./–º–µ—Å—è—Ü"
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –æ–ø–ª–∞—Ç—ã, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞
    try:
        if not is_active:
            payment_url = await create_payment_link(user_id)
            
            # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É
            logger.info(f"–°–æ–∑–¥–∞–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {payment_url}")
            
            keyboard = [
                [InlineKeyboardButton("–û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É", url=payment_url)]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π –æ–ø–ª–∞—Ç—ã
            await update.message.reply_text(
                message_text,
                reply_markup=reply_markup
            )
        else:
            # –î–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∫–Ω–æ–ø–∫–∏ –æ–ø–ª–∞—Ç—ã
            await update.message.reply_text(message_text)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ –∫–Ω–æ–ø–∫–∏
        await update.message.reply_text(
            message_text + "\n\n–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ–ø–ª–∞—Ç–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )

# –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ö—ç–Ω–¥–ª–µ—Ä—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–µ–±—Ö—É–∫–æ–≤ –æ—Ç –Æ–∫–∞—Å—Å—ã
# –ù–∞–ø—Ä–∏–º–µ—Ä:
# async def process_payment_notification(payment_data):
#     """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ –æ—Ç –Æ–∫–∞—Å—Å—ã"""
#     payment_id = payment_data.get('object', {}).get('id')
#     status = payment_data.get('object', {}).get('status')
#     metadata = payment_data.get('object', {}).get('metadata', {})
#     user_id = metadata.get('user_id')
#     
#     if status == 'succeeded':
#         # –£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂, –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –ø–æ–¥–ø–∏—Å–∫—É
#         # –ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫–æ–¥ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
#         logger.info(f"–£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞: {payment_id} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
#     else:
#         logger.warning(f"–ü–ª–∞—Ç–µ–∂ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω: {payment_id}, —Å—Ç–∞—Ç—É—Å: {status}")

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–º–æ–∫–æ–¥—ã –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è
load_promo_codes() 