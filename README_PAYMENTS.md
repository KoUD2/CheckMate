# Настройка платежей через Юкассу

В этой инструкции описано, как настроить и тестировать платежи через Юкассу в боте CheckMate.

## Реализованная функциональность

1. Команда `/subscription` - показывает статус подписки пользователя и предлагает оплатить подписку
2. Интеграция с тестовым API Юкассы для создания платежей
3. Сервер для обработки вебхуков от Юкассы
4. Активация подписки после успешной оплаты
5. Отправка уведомлений пользователю о статусе платежа

## Настройка API Юкассы

1. Тестовый API-ключ: `test_oqu9vEtaRtFtuDFnCyUDblip-i9Ceb-EV5NDtQ4PHVg`
2. ID магазина: `1035098` (тестовый магазин)
3. Стоимость подписки: 149 рублей/месяц

## Как тестировать платежи

1. Отправьте команду `/subscription` боту
2. Нажмите на кнопку "Оплатить подписку"
3. В тестовом режиме используйте следующие данные карты:
   - Номер карты: `1111 1111 1111 1026`
   - Срок действия: любой в будущем
   - CVC: любой
   - Владелец: любой

## Тестирование статусов оплаты

Для локального тестирования успешной оплаты и отмены платежа можно использовать встроенный тестовый эндпоинт:

1. **Успешный платеж**: Откройте в браузере: `http://localhost:8080/test/payment?user_id=YOUR_USER_ID&status=succeeded`
2. **Отмененный платеж**: Откройте в браузере: `http://localhost:8080/test/payment?user_id=YOUR_USER_ID&status=canceled`

Замените `YOUR_USER_ID` на ID пользователя в Telegram, которому нужно отправить уведомление о платеже.

## Настройка вебхуков

Для полноценной работы платежей необходимо настроить вебхуки от Юкассы. В текущей реализации вебхуки принимаются на локальном сервере на порту 8080. Для продакшн нужно:

1. Выставить сервер в интернет (например, через ngrok или на хостинге)
   ```
   # Пример запуска ngrok для тестирования
   ngrok http 8080
   ```
2. Указать URL вебхука в личном кабинете Юкассы: `https://ваш-домен/webhooks/yookassa`

## Уведомления о статусе платежа

При изменении статуса платежа пользователь получает уведомления:

1. **Успешная оплата**: "✅ Оплата прошла успешно! Ваша подписка активирована до [дата]. Осталось дней: [количество]."
2. **Отмена платежа**: "❌ Платеж отменен. Вы можете попробовать снова, отправив команду /subscription."

## Переход на боевой режим

Для перехода из тестового в боевой режим необходимо:

1. Получить боевые API-ключи в Юкассе
2. Заменить константы `YOOKASSA_API_KEY` и `YOOKASSA_SHOP_ID` в файле `services/payment_service.py`
3. Настроить вебхуки на боевом сервере

## Текущая реализация

1. Подписки хранятся в оперативной памяти, при перезапуске бота информация о подписках теряется
2. Для полноценного решения рекомендуется реализовать хранение подписок в базе данных

## Структура кода

- `services/payment_service.py` - Работа с API Юкассы, создание платежей
- `services/payment_callbacks.py` - Обработка уведомлений о платежах, активация подписок
- `handlers/subscription_handlers.py` - Обработчик команды /subscription
- `webhook_server.py` - Сервер для приема вебхуков от Юкассы
